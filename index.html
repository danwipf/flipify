<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Fabiatster</title>

    <style>
        :root{
            --bg:#07070a;
            --panel:#141418;
            --border:rgba(255,255,255,.12);
            --text:rgba(255,255,255,.92);
            --muted:rgba(255,255,255,.65);
            --accent:#ff0033;
            --radius:18px;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            min-height:100vh;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
            color:var(--text);
            background:radial-gradient(900px 600px at 50% 0%, rgba(255,0,51,.14), transparent 55%), var(--bg);
            display:flex;
            justify-content:center;
        }
        .wrap{width:min(560px,100%); padding:18px 16px 28px;}
        h1{text-align:center; margin:10px 0 4px;}
        .sub{text-align:center; color:var(--muted); margin-bottom:16px;}
        .panel{
            background:var(--panel);
            border:1px solid var(--border);
            border-radius:var(--radius);
            padding:14px;
            margin:12px 0;
        }
        .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
        button{
            padding:12px 14px;
            border-radius:14px;
            border:1px solid var(--border);
            background:rgba(255,255,255,.06);
            color:var(--text);
            font-weight:750;
            cursor:pointer;
        }
        button.primary{
            background:var(--accent);
            border-color:var(--accent);
            color:#0b0c10;
        }
        #reader{
            width:100%;
            border-radius:14px;
            overflow:hidden;
            margin-top:12px;
            display:none;
        }
        .countdown{
            font-size:80px;
            font-weight:900;
            text-align:center;
            margin:20px 0;
            color:var(--accent);
        }
        .msg{margin-top:10px; font-size:14px;}
    </style>
</head>

<body>
<div class="wrap">
    <h1>Fabiatster</h1>
    <p class="sub">QR scannen</p>

    <div class="panel">
        <div class="row">
            <button class="primary" id="btnStart">📷 Scanner starten</button>
            <label style="display:flex;align-items:center;gap:6px;">
                <input type="checkbox" id="timerToggle">
                3s Timer
            </label>
        </div>
        <div id="reader"></div>
        <div id="scanStatus" class="msg"></div>
        <div id="countdown" class="countdown"></div>
        <div id="manualOpen"></div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    let scanner = null;

    const $ = id => document.getElementById(id);

    function extractVideoId(text){
        text = (text||"").trim();
        let m = text.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/);
        if(m) return m[1];
        m = text.match(/[?&]v=([a-zA-Z0-9_-]{6,})/);
        if(m) return m[1];
        m = text.match(/^([a-zA-Z0-9_-]{6,})$/);
        if(m) return m[1];
        return null;
    }

    function openYouTubeMusic(videoId){
        const webUrl = `https://music.youtube.com/watch?v=${videoId}`;
        const ua = navigator.userAgent || "";
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);

        if(isAndroid){
            const intentUrl =
                `intent://music.youtube.com/watch?v=${videoId}` +
                `#Intent;scheme=https;package=com.google.android.apps.youtube.music;end`;
            window.location.href = intentUrl;
            setTimeout(()=>{ window.location.href = webUrl; },1000);
            return;
        }

        if(isIOS){
            window.location.href = webUrl; // iOS nutzt Universal Link
            return;
        }

        window.location.href = webUrl;
    }

    async function handleScan(decodedText){
        const id = extractVideoId(decodedText);
        if(!id){
            $("scanStatus").textContent = "Kein Video erkannt.";
            return;
        }

        if(scanner){
            try{ await scanner.stop(); }catch(e){}
        }

        $("scanStatus").innerHTML = "🎵 Song erkannt!";
        $("manualOpen").innerHTML =
            `<button class="primary" id="manualBtn">Manuell öffnen</button>
     <div class="msg"><a href="https://music.youtube.com/watch?v=${id}">
     Website öffnen (Fallback)</a></div>`;

        $("manualBtn").onclick = ()=> openYouTubeMusic(id);

        if($("timerToggle").checked){
            let seconds = 3;
            $("countdown").textContent = seconds;

            const interval = setInterval(()=>{
                seconds--;
                $("countdown").textContent = seconds;

                if(seconds <= 0){
                    clearInterval(interval);
                    $("countdown").textContent = "";
                    openYouTubeMusic(id);
                }
            },1000);

        } else {
            openYouTubeMusic(id);
        }
    }

    async function startScanner(){
        $("reader").style.display = "block";
        $("scanStatus").textContent = "Scanner läuft...";
        $("countdown").textContent = "";
        $("manualOpen").innerHTML = "";

        scanner = new Html5Qrcode("reader");
        await scanner.start(
            {facingMode:"environment"},
            {fps:12, qrbox:250},
            handleScan
        );
    }

    $("btnStart").addEventListener("click",()=>{
        startScanner().catch(err=>{
            $("scanStatus").textContent = "Kamera Fehler: "+err;
        });
    });
</script>
</body>
</html>